使用示例
=========================

本篇旨在介绍 OBDUMPER 支持的常见业务场景并提供对应的使用示例。

下表为示例中使用的数据库信息：


|              **数据库信息**              |   **示例值**    |
|-------------------------------------|--------------|
| 集群名                                 | cluster_a    |
| OceanBase DataBase Proxy (ODP) 主机地址 | 10.0.0.0     |
| OceanBase DataBase Proxy (ODP) 端口号  | 2883         |
| 集群的租户名                              | mysql        |
| sys 租户下 root/proxyro 用户名 |\*\*u\*\*\*|
| sys 租户下 root/proxyro 用户的密码          | \*\*\*\*\*\* |
| 业务租户下的用户账号（要求读写权限）                  | test         |
| 业务租户下的用户密码                          | \*\*\*\*\*\* |
| Schema 名称                           | USERA        |



导出 DDL 定义文件
--------------------------------

**场景描述**：将 Schema USERA 中所有已支持的对象定义语句导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。

**示例语句**：

```shell
[admin@localhost]> ./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --ddl --all -f /output
```

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p><code>--sys-user</code> 选项用于连接 sys 租户下拥有特定权限的用户。导出时如果未指定 <code>--sys-user</code> 选项，默认指定的是 <code>--sys-user root</code>。</p>
  </main>

**任务结果示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/export%20ddl.png" width = "560" height = "135" alt="export ddl" />

**导出内容示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/cat%20export%20ddl.png" width = "560" height = "135" alt="cat export ddl" />


导出 CSV 数据文件
--------------------------------

**场景描述**：将 Schema USERA 中所有表中的数据按照 CSV 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。CSV 数据文件（后缀名 .csv）请参考 [RFC 4180](http://mirrors.nju.edu.cn/rfc/inline-errata/rfc4180.html) 规范，CSV 数据文件以纯文本形式存储，可通过文本编辑器或者 Excel 等工具直接打开。

**示例语句**：

```shell
[admin@localhost]> ./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --csv --table '*' -f /output 
```

**任务结果示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/export%20csv.png" width = "560" height = "135" alt="export csv" />

**导出内容示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/cat%20export%20csv.png" width = "560" height = "135" alt="cat export csv" />


导出 SQL 数据文件
--------------------------------


**场景描述**：将 Schema USERA 中所有表中的数据按照 SQL 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。SQL 数据文件（后缀名 .sql）存储的是 Insert SQL 语句，可通过文本编辑器或者 SQL 编辑器等工具直接打开。

**示例语句**：

```shell
[admin@localhost]> ./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --sql --table '*' -f /output
```

**任务结果示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/export%20sql.png" width = "560" height = "135" alt="export sql" />

**导出内容示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/cat%20export%20sql.png" width = "560" height = "135" alt="cat export sql" />


导出 CUT 数据文件
--------------------------------

**场景描述**： 将 Schema USERA 中所有表中的数据按照 CUT 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。同时指定导出数据的列分隔字符串为 `|@|`。CUT 数据文件（后缀名 .dat）中的数据是以单个字符或者字符串分隔，可通过文本编辑器等工具直接打开。

**示例语句**：

```shell
./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --table '*' -f /output --cut --column-splitter '|@|' --trail-delimiter
```

**任务结果示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/export%20cut.png" width = "560" height = "135" alt="export cut" />

**导出内容示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/cat%20export%20cut.png" width = "560" height = "135" alt="cat export cut" />

自定义导出文件名
-----------------------------

**场景描述**： 将 Schema USERA 中 table 表的数据按照 CSV 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。同时指定导出的文件名称为 filetest。

**示例语句**：

```shell
./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --csv --table 'table' --file-name 'filetest.txt' -f /output
```

**任务结果示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/export%20customize%20file%20name.png" width = "560" height = "135" alt="customize export file name" />

**导出内容示例**：

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/obloaderobdumper/332/cat%20export%20customize%20file%20name.png" width = "560" height = "135" alt="cat export customize file name" />


导出数据时使用控制文件
-------------------------------

**场景描述**： 将 Schema USERA 中 table 表的数据按照 CSV 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。同时指定控制文件的路径为 `/output`，为导出的数据进行预处理。

**示例语句**：

```shell
./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --table'table' -f /output --csv --ctl-path /output
```

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>要求数据库中定义的表名与其对应的控制文件名大小写一致，否则 OBLOADER 无法识别控制文件。控制文件的定义规则可参考 <a href="../5.OBLOADER/3.obloader-data-processing/2.obloader-preprocessing-functions.md">预处理函数</a>。</p>
  </main>


导出表中指定列的数据 
-------------------------------

**场景描述**： 将 Schema USERA 中 table 表的数据按照 CSV 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。同时指定 `--exclude-column-names` 选项忽略表中不需要被导出的列。

**示例语句**：

```shell
./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA -f /output --table'table' --csv --exclude-column-names 'deptno'
```



导出自定义查询结果集
-------------------------------

**场景描述**： 将 `--query-sql` 选项指定的查询语句执行的结果集按照 CSV 格式导出到 `/output` 目录中（OceanBase 4.0.0.0 之前的版本要求提供 sys 租户的密码）。

**示例语句**：

```shell
./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA -f /output --csv --query-sql 'select deptno,dname from dept where deptno<3000'
```

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>用户需要保证 SQL 查询语句的语法正确性以及查询性能。</p>
  </main>


公共云导出模式和数据
--------------------------------

**场景描述**：***用户无法提供 sys 租户密码时***，将公共云 Schema USERA 中所有已定义的数据库对象和表数据导出到 `/output` 目录中。

**示例语句**：

```shell
[admin@localhost]> ./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** -D USERA --ddl --csv --public-cloud --all -f /output
```

私有云导出模式和数据
--------------------------------

**场景描述**：***用户无法提供 sys 租户密码时***，将私有云 Schema USERA 中所有已定义的数据库对象和表数据导出到 `/output` 目录中。

**示例语句**：

```shell
[admin@localhost]> ./obdumper -h 10.0.0.0 -P 2883 -u test -p ****** -c cluster_a -t mysql-D USERA --ddl --csv --no-sys --all -f /output
```

  <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>在公共云或者私有云环境中无法提供 sys 租户密码时，导出数据库对象定义功能可能存在缺陷。例如：MySQL 租户无法导出序列定义；OceanBase 2.2.70 之前的版本，无法导出表组定义；OceanBase Oracle 2.2.30 及之前的版本，无法导出索引定义；OceanBase 2.2.70 之前的版本，无法导出唯一索引的分区信息；OceanBase Oracle 2270 (含) ~ 4.0.0.0 的版本，无法导出分区表的唯一索引定义。</p>
  </main>

使用安全密钥文件
---------------------------

导数工具 3.1.0 及之后版本支持使用密钥文件来实现导数需求，支持使用密钥文件代替在命令行中直接指定 sys 租户的密码。具体步骤如下：

1. 利用 openssl 生成公私钥，并对 `sys-password` 加密。

   ```shell
   # 1.首先使用 genrsa 生成私钥
   openssl genrsa -out xxx.pem 1024
   
   # 2.利用私钥生成公钥
   openssl rsa -in xxx.pem -pubout -out xxx.pem
   
   # 3.对私钥进行格式转换，需配置到 properties 中
   openssl pkcs8 -topk8 -in xxx.pem -out xxx.pem -nocrypt
   
   # 4.利用公钥加密 sys-password 文件，并将加密过的密文输出到文件
   openssl rsautl -encrypt -pubin -inkey xxx.pem -in pwd.txt -out xxx.txt
   ```

   

2. 修改 `conf` 目录下的 decrypt.properties 文件。

   ```properties
   # Your encrypted password path
   # 填入已加密的密码地址，对应步骤 1 中的 xxx.txt
   encrypted.password.path=xxx/xxx/xxx.txt
   
   # Your private key path
   # 填入步骤 1 中第三步生成的私钥文件地址 xxx.pem
   private.key.path=xxx/xxx/xxx.pem
   
   # The full class name of your own decrypt jar package.
   # If you want to decrypt sys-password using your own or default decryptor,
   # you must provide your class name or default class name.
   # 如用户未提供解密 jar 包，则使用默认的解密程序
   decrypt.class.name=com.oceanbase.tools.loaddump.decrypt.OpenSslDecryptor
   ```


加密敏感信息
---------------------------

导数工具 4.2.0 及之后版本支持对命令行中的敏感信息进行加密。具体步骤如下：

### 方法一：通过 openssl 配置

1. 确认当前环境已安装 openssl，并被配置到环境变量。

   ```shell
   $ which openssl

   /usr/bin/openssl
   ```

2. 支持指定本地文件作为加密文件和在编辑界面中编辑加密的敏感信息。

   - 使用本地文件作为待加密文件。

      ```shell
      $ ./secure-gen -n <file_path>
      ```

      加密的文件格式需符合 [Property File Format 规范](https://docs.oracle.com/cd/E23095_01/Platform.93/ATGProgGuide/html/s0204propertiesfileformat01.html)。
      
      目前 OBDUMPER 支持加密的敏感字段包括：

      |  **参数** |**说明**|
      |-----------|--------|
      |password|非必选项。业务租户的密码。|
      |sys.password|非必选项。sys 租户下的账户密码。|
      |access.key|非必选项。Access Key，适用于云存储服务。例如：S3, OSS。|
      |secret.key|非必选项。Secret Key，适用于云存储服务。例如：S3, OSS。|
       
      **任务结果示例**：

      ```shell
      password=foo
      sys.password=bar
      ```
   - 在编辑界面中编辑加密的敏感信息。
     
     1. 在 `${ob-loader-dumper}/bin/` 目录下执行以下命令。

         ```shell
         $ ./secure-gen -i
         ```

      2. 在编辑界面中输入需要加密的敏感信息。完成后输入 `:wq` 保存进入下一步。

         ```shell
         # Input the sensitive fields below in plain-text respectively.
         # Note you can leave any of them as blank, ob-loader-dumper will parse from cli args first, and override any field if there is a conflict。
         #
         # Database password.
         #password=
         #
         # Database password for sys tenant. Note, A secure.crt file takes priority over this field.
         #sys.password=
         #
         # Access key for cloud storage like oss & s3.
         #access.key=
         #
         # Secret key for cloud storage like oss & s3.
         #secret.key=
         
         
         :wq
         ```

       3. 如果之前已经生成过一次密钥（通过目录检测），会提示用户是否使用之前的密钥。

          ```shell
          $ ./secure-gen
          Detected that a key already exists, do you want to use it? 
          If not, a new key will be generated and overwrite the existing key (y/n): 
          ```
       4. 输入 `y` ，脚本通过 openssl 生成私钥（key.pem）和公钥（key.pem.pub），默认路径为 <用户根目录>/.loaddump/secure，并提示用户相应的路径：

          ```shell
          Detected that a key already exists, do you want to use it? 
          If not, a new key will be generated and overwrite the existing key (y/n): n
          Generating RSA private key, 4096 bit long modulus
          ............++
          .......................................................++
          e is 65537 (0x10001)
          writing RSA key
          
          The key pair has been generated under the directory /Users/chang/.loaddump, please keep it safe.
          The encrypted file /Users/chang/.loaddump/secure/secure.rsa has been generated for sensitive information.
          
          If you want to use it, please fill in the corresponding content in conf/decrypt.properties properly.
          ```

       5. 输入 `n`，脚本通过已存在的密钥对生成加密文件（secure.rsa），默认路径为 <用户根目录>/.loaddump/secure，并同样提示用户相应的路径：

          ```shell
          Detected that a key already exists, do you want to use it? If not, a new key will be generated and overwrite the existing key (y/n): y
          The encrypted file /Users/chang/.loaddump/secure/secure.rsa has been generated for sensitive information.
          
          If you want to use it, please fill in the corresponding content in conf/decrypt.properties properly.
          ```

       6. 验证密钥与加密文件是否生成成功。

          ```shell
          $ ls ～/.loaddump/secure/
          key.pem     key.pem.pub    secure.rsa
          ```

       7. 通过在 <程序根目录>/conf/decrypt.properties 中设置相应的内容，即可通过加密方式来运行导数工具。
        
          ```shell
          # Absolute path of your secure file, whose name is secure.rsa by default.
          # secure.file.path=
          
          # Absolute path of your private key. whose name is key.pem by default.
          # private.key.path=
          
          # Decrypt class name. Fill in this field only if you need a custom mechanism of decryption.
          # decrypt.class.name=
          ```

### 方法二：自定义配置

如未安装 openssl，支持自定义加密和解密敏感信息。

自定义加密和解密敏感信息需要遵循以下要求：

1. 自己编写一个解密类。要求如下：
  
   1. 必须拥有无参构造函数。

   2. 拥有非静态方法：`public String decrypt(String encryptRaw)`。其中形参 `encryptRaw` 为加密后的文本，返回值为解密后的文本。

2. 编译并将 JAR 包移入类加载路径，使程序可以正确获取到该类。

3. 在 <程序根目录>/conf/decrypt.properties 配置相应的内容。

以编写一个 CustomDecryptor 类且使用 Base64 进行编解码为例，具体步骤如下。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>实际生产环境中，可以根据需求使用复杂的加解密算法。</p>
</main>

1. 新建一个项目，编写 CustomDecryptor.java。

   ```Java
   package com.example;
   
   import java.nio.charset.StandardCharsets;
   import sun.misc.BASE64Decoder;
   
   public class CustomDecryptor {
   
       /**
       * This method takes an encrypted string, decrypt it, and return it as a plain string.
       */
       public String decrypt(String encryptedRaw) throws Exception {
           BASE64Decoder decoder = new BASE64Decoder();
           return new String(decoder.decodeBuffer(encryptedRaw), StandardCharsets.UTF_8);
       }
   
   ```


2. 将已编译的 JAR 包移动到类加载路径下。


3. 解密器设置完成后，可以通过对应的加密算法加密敏感信息。本例使用 Base64 编码：

   ```shell
   # 编码前：
   $ cat password.txt
   password=123456
   sys_password=123456
   
   # 将编码后的字符串保存至 custom.key 文件。
   $ echo $(base64 password.txt) > ～/tmp/custom.key
   ```

4. 在 `conf/decrypt.properties` 中设置相应的内容。

   ```shell
   # Absolute path of your secure file, whose name is secure.rsa by default.
   secure.filePath=～/tmp/custom.key
   # Absolute path of your private key. whose name is key.pem by default.
   # private.key.path=
   # Decrypt class name. Fill in this field only if you need a custom mechanism of decryption.
   decrypt.className=com.example.CustomDecryptor
   ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>由于为自定义方式，<code>private.key.path</code> 可以不填，该参数适用于默认的 RSA 算法。 </p>
   </main>

设置会话级别变量
-----------------------------

```properties
# This variable is used to init session.
# The default value is 5 min.
ob.query.timeout.for.init.session=5

# This variable is used to init session.
# The default value is 5 min.
ob.trx.timeout.for.init.session=5

# This variable is used to query metadata, such as
#   for query database;
#   for query row key, primary key, macro range;
#   for query primary key;
#   for query unique key;
#   for query load status;
# The default value is 5 min.
ob.query.timeout.for.query.metadata=5

# This variable is used to dump record for CSV, CUT and SQL
# The default value is 24 hours
ob.query.timeout.for.dump.record=24

# This variable is used to dump record for query-sql
# The default value is 5 hours
ob.query.timeout.for.dump.custom=5

# This variable is used to execute DDL, such as load schema, truncate table
# The default value is 1 min
ob.query.timeout.for.exec.ddl=1

# This variable is used to execute DML, such as delete table
# The default value is 1 hour
ob.query.timeout.for.exec.dml=1

# This variable is used to dump record for CSV, CUT and SQL
# The default value is 24 hours
ob.trx.timeout.for.dump.record=24

# This variable is used to dump record for query-sql
# The default value is 5 hours
ob.trx.timeout.for.dump.custom=5

# This variable is used to dump record for CSV, CUT and SQL
# The default value is 24 hours
ob.net.read.timeout.for.dump.record=24

# This variable is used to dump record for query-sql
# The default value is 5 hours
ob.net.read.timeout.for.dump.custom=5

# This variable is used to dump record for CSV, CUT and SQL
# The default value is 24 hours
ob.net.write.timeout.for.dump.record=24

# This variable is used to dump record for query-sql
# The default value is 5 hours
ob.net.write.timeout.for.dump.custom=5

# This variable is used to set session variable ob_proxy_route_policy
# The default value is follower_first
ob.proxy.route.policy=follower_first


# This variable is used to set jdbc url option useSSL
# The default value is false
jdbc.url.use.ssl=false

# This variable is used to set jdbc url option useUnicode
# The default value is true
jdbc.url.use.unicode=true

# This variable is used to set jdbc url option socketTimeout
# The default value is 30 min
jdbc.url.socket.timeout=30

# This variable is used to set jdbc url option connectTimeout
# The default value is 3 min
jdbc.url.connect.timeout=3

# This variable is used to set jdbc url option characterEncoding
# The default value is utf8
jdbc.url.character.encoding=utf8

# This variable is used to set jdbc url option useCompression
# The default value is true
jdbc.url.use.compression=true

# This variable is used to set jdbc url option cachePrepStmts
# The default value is true
jdbc.url.cache.prep.stmts=true

# This variable is used to set jdbc url option noDatetimeStringSync
# The default value is true
jdbc.url.no.datetime.string.sync=true

# This variable is used to set jdbc url option useServerPrepStmts
# The default value is true
jdbc.url.use.server.prep.stmts=true

# This variable is used to set jdbc url option allowMultiQueries
# The default value is true
jdbc.url.allow.multi.queries=true

# This variable is used to set jdbc url option rewriteBatchedStatements
# The default value is true
jdbc.url.rewrite.batched.statements=true

# This variable is used to set jdbc url option useLocalSessionState
# The default value is true
jdbc.url.use.local.session.state=true

# This variable is used to set jdbc url option zeroDateTimeBehavior
# The default value is convertToNull
jdbc.url.zero.datetime.behavior=convertToNull

# This variable is used to set jdbc url option verifyServerCertificate
# The default value is false
jdbc.url.verify.server.certificate=false

# This variable is used to set jdbc url option usePipelineAuth
# The default value is false
jdbc.url.use.pipeline.auth=false

# This variable is used to set jdbc url option socketProxyHost
# The default value is null
jdbc.url.socks.proxy.host=null

# This variable is used to set jdbc url option socketProxyPort
# The default value is null
jdbc.url.socks.proxy.port=null
```