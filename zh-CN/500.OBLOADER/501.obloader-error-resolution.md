# 错误处理功能

用户使用 OBLOADER 导入数据时，如果出现错误会导致导入重复数据。导数工具 4.2.4 及之后的版本，用户可以指定 `--strict` 选项以在导入数据出现错误时结束进程。用户可以根据生成的报错文件，手动修复此类错误。

本文档旨在介绍使用 OBLOADER 导入数据时出现的错误类型以及使用示例。

## 错误类型

### 有效错误

#### 数据错误

|**错误类型** |**说明**|
|--------|------|
| 数据类型不匹配  |例如：将 VARCHAR 类型数据插入到 INT 类型的列中。 |
| 非法的 NULL 值 |设置了非空约束。 |
| 数据类型溢出 |字符串超长或者整型超长。 |
| 预处理数据失败  |使用控制文件，预处理函数调用失败。 |
| 列数不匹配  |文件列数与数据库列数不匹配。 |
| 主键或者唯一键重复  | 表中的主键或者唯一键出现重复。|

- 导入数据出现数据错误时，导入任务不可重试。

- 可在 `{ob-loader-dumper}/ob-loader-dumper.bad` 文件中查看数据类型不匹配/非法的 NULL 值/数据类型溢出/预处理数据失败/列数不匹配错误；在 `{ob-loader-dumper}/ob-loader-dumper.bad` 文件中查看主键或者唯一键重复错误。

#### 环境错误

|**错误类型** |**说明**|
|--------|------|
| 网络错误  |<ul><li>连接超时。</li><li>连接断开。</li><li>IO 超时。</li></ul> |
| 数据库系统错误 |<ul><li>事务终止。</li><li>事务回滚。</li><li>租户内存达到阈值。</li><li>服务端超时。</li></ul> |

- 导入数据出现环境错误时，单个导入任务可重试最多 5 次，不支持自定义重试数量。达到重试阈值后，导入任务失败并结束进程。

- 导入包含非主键/非唯一键的表出现环境错误时，导入任务不会重试，导入失败并结束进程，以避免同一批数据的二次插入。

## 无效错误


|**错误类型** |**说明**|
|--------|------|
| 数据类型不匹配  |例如：将 VARCHAR 类型数据插入到 INT 类型的列中。 |
| 非法的 NULL 值 |设置了非空约束。 |
| 数据类型溢出 |字符串或者整型数据超长。 |
| 预处理数据失败  |使用控制文件，预处理函数调用失败。 |
| 列数不匹配  |文件列数与数据库列数不匹配。 |
| 主键或者唯一键重复  | 表中的主键或者唯一键出现重复。|

导入数据出现无效错误时，导入任务不可重试，任务失败并结束进程。

## 使用示例

该示例中，导入的数据存在已知的错误。出现该错误的解决方法如下：

1. 准备数据。

   **示例语句**：

   ```sql

   ```

2. 通过 OBLOADER 导入数据，并指定 `--strict` 选项以在导入数据出现错误时结束进程。

   **示例语句**：

    ```shell
    $./obloader -h xx.x.x.x -P 2883 -u test -p ****** --sys-user **u*** --sys-password ****** -c cluster_a -t mysql -D USERA --csv --table '*' --ctl-path /home/controls/ -f /output --strict=true
    ```

    其中，`--strict=true` 选项用于出现错误时结束进程，false 表示出现错误时跳过错误继续进程。该选项可与 <code>--max-discards</code> 或者 <code>--max-errors</code> 选项搭配使用，表示当重复数据量或者错误数在指定范围内，会跳过错误继续进程。

3. 运行 OBLOADER，出现错误，导入任务失败并退出程序。

   **任务结果示例**：

   ```shell
   ...
    All Load Tasks Finished:

    ----------------------------------------------------------
    |  No.#  | Type   | Name       | Count       | Status    | 
    ----------------------------------------------------------    
    |  1     | TABLE  | loader     | 1 -> 1      | SUCCESS   |                
    ----------------------------------------------------------

   Total Count: 1          End Time: 2023-07-04 07:13:01
   ...
   ```

4. 在 `{ob-loader-dumper}/ob-loader-dumper.bad` 文件中查看错误信息。

   ```shell
   ...
    
   ...
   ```

5. 数据清洗。